#!/usr/bin/env -S sd nix shell
#!nix-shell -i python3 -p python3Packages.face_recognition python3Packages.opencv4 python3Packages.tqdm

# The idea here is to cluster a set of images of faces
# ~stolen~ inspired from https://pyimagesearch.com/2018/07/09/face-clustering-with-python/
# demo dataset: https://www.kaggle.com/datasets/rawatjitesh/avengers-face-recognition

import faulthandler
faulthandler.enable()

import dlib
dlib.get_frontal_face_detector()

import face_recognition
import cv2
from pathlib import Path
import numpy as np
import pandas as pd
from argparse import ArgumentParser
from sys import stderr

parser = ArgumentParser()
parser.add_argument("images", help="Where images are stored")

args = parser.parse_args()

for (i, image_path) in args.images.iterdir():
    print(f"[*] Processing {image_path}", file=stderr)
    image = cv2.imread(image_path)
    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    boxes = face_recognition.face_locations(image, model='cnn')
    embeddings = face_recognition.face_encodings(image, boxes)
    for (box, enbedding) in zip(boxes, embeddings):
        print(image_path, box, embedding)
